<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Penjualan Rokok</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 30px; }
    canvas { max-width: 600px; margin-bottom: 40px; }
  </style>
</head>

<body>

<h1>Dashboard Penjualan Rokok (Minggu Ini)</h1>
<h2 id="totalIncome"></h2>

<canvas id="qtyChart"></canvas>
<canvas id="incomeChart"></canvas>

<script>
const rokokMap = {
  1: "OFO",
  2: "HD",
  3: "GP",
  4: "SURYA12"
};

const hargaMap = {
  1: 12000,
  2: 16000,
  3: 22000,
  4: 27000
};
function isThisWeek(dateStr) {
  const now = new Date();
  const d = new Date(dateStr);

  const start = new Date(now);
  start.setDate(now.getDate() - now.getDay());
  start.setHours(0,0,0,0);

  const end = new Date(start);
  end.setDate(start.getDate() + 7);

  return d >= start && d < end;
}
  fetch("https://api.thingspeak.com/channels/3212911/feeds.json?api_key=1UFX45MJDHU0E4C5&results=8000")
  .then(res => res.json())
  .then(data => {

    let qtyPerRokok = {};
    let incomePerRokok = {};
    let totalIncome = 0;

    data.feeds.forEach(feed => {

      if (!isThisWeek(feed.created_at)) return;
      if (!feed.field1 || !feed.field2) return;

      const jenis = parseInt(feed.field1);
      const qty = parseInt(feed.field2);

      if (!rokokMap[jenis]) return;

      const nama = rokokMap[jenis];
      const harga = hargaMap[jenis];

      if (!qtyPerRokok[nama]) qtyPerRokok[nama] = 0;
      if (!incomePerRokok[nama]) incomePerRokok[nama] = 0;

      qtyPerRokok[nama] += qty;
      incomePerRokok[nama] += qty * harga;
      totalIncome += qty * harga;
    });

    renderQtyChart(qtyPerRokok);
    renderIncomeChart(incomePerRokok);
    showTotalIncome(totalIncome);
  });
function renderQtyChart(data) {
  new Chart(document.getElementById("qtyChart"), {
    type: "pie",
    data: {
      labels: Object.keys(data),
      datasets: [{
        data: Object.values(data),
        backgroundColor: ["#4CAF50","#2196F3","#FFC107","#E91E63"]
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: "Perbandingan Rokok Terjual"
        }
      }
    }
  });
}

function renderIncomeChart(data) {
  new Chart(document.getElementById("incomeChart"), {
    type: "bar",
    data: {
      labels: Object.keys(data),
      datasets: [{
        label: "Penghasilan (Rp)",
        data: Object.values(data),
        backgroundColor: "#673AB7"
      }]
    },
    options: {
      scales: {
        y: {
          ticks: {
            callback: v => "Rp " + v.toLocaleString("id-ID")
          }
        }
      }
    }
  });
}

function showTotalIncome(total) {
  document.getElementById("totalIncome").innerHTML =
    "Total Penghasilan Minggu Ini: <b>Rp " +
    total.toLocaleString("id-ID") + "</b>";
}
</script>
</body>
</html>

