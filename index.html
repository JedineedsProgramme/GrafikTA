<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Penjualan Rokok</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    canvas { max-width: 800px; margin-bottom: 50px; }
  </style>
</head>
<body>

<h2>ðŸ“Š Perbandingan Rokok Terjual</h2>
<canvas id="rokokChart"></canvas>

<h2>ðŸ’° Penghasilan per Minggu</h2>
<canvas id="incomeChart"></canvas>

<h2>ðŸ“¦ Jumlah Rokok Terjual per Minggu</h2>
<canvas id="qtyChart"></canvas>

<script>
const CHANNEL_ID = "3212911";
const READ_API_KEY = "1UFX45MJDHU0E4C5";

const API_URL = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=500`;

// ===== Hitung Minggu =====
function getWeek(dateStr) {
  const d = new Date(dateStr);
  const oneJan = new Date(d.getFullYear(),0,1);
  return Math.ceil((((d - oneJan) / 86400000) + oneJan.getDay()+1)/7);
}

fetch(API_URL)
.then(res => res.json())
.then(json => {

  const data = json.feeds
    .filter(f => f.field1 && f.field2 && f.field3)
    .map(f => ({
      waktu: f.created_at,
      nama: f.field1,
      qty: Number(f.field2),
      penjualan: Number(f.field3)
    }));

  // === Grafik 1: Perbandingan Rokok ===
  const rokok = {};
  data.forEach(d => {
    rokok[d.nama] = (rokok[d.nama] || 0) + d.qty;
  });

  new Chart(rokokChart, {
    type: "pie",
    data: {
      labels: Object.keys(rokok),
      datasets: [{ data: Object.values(rokok) }]
    }
  });

  // === Grafik Mingguan ===
  const income = {};
  const qtyWeek = {};

  data.forEach(d => {
    const w = "Minggu " + getWeek(d.waktu);
    income[w] = (income[w] || 0) + d.penjualan;
    qtyWeek[w] = (qtyWeek[w] || 0) + d.qty;
  });

  new Chart(incomeChart, {
    type: "bar",
    data: {
      labels: Object.keys(income),
      datasets: [{ label: "Pendapatan (Rp)", data: Object.values(income) }]
    }
  });

  new Chart(qtyChart, {
    type: "bar",
    data: {
      labels: Object.keys(qtyWeek),
      datasets: [{ label: "Qty Terjual", data: Object.values(qtyWeek) }]
    }
  });

});
</script>

</body>
</html>
