<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Penjualan Rokok</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
  h1 { text-align: center; margin-bottom: 5px; }
  h2 { text-align: center; margin-top: 0; color: #2e7d32; }
  .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .card { background: #ffffff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  canvas { max-height: 300px; }
  .text-center { text-align: center; }
  .ranking p { margin: 5px 0; }
  .statement { font-weight: bold; background: #e8f5e9; padding: 10px; border-radius: 8px; }
</style>
</head>

<body>

<h1>Dashboard Penjualan Rokok</h1>
<h2 id="weeklyIncome">Total Penghasilan Minggu Ini: Rp 0</h2>

<div class="dashboard">

  <!-- 1. Ringkasan Penjualan Hari Ini -->
  <div class="card">
    <h3 class="text-center">Penjualan Hari Ini</h3>
    <div id="todaySummary" class="text-center">Memuat data...</div>
  </div>

  <!-- 2. Pie chart perbandingan jenis rokok minggu ini -->
  <div class="card">
    <h3 class="text-center">Perbandingan Jenis Rokok Terjual (Minggu Ini)</h3>
    <canvas id="pieChart"></canvas>
    <div id="pieDetail" class="text-center"></div>
  </div>

  <!-- 3. Bar chart penjualan 4 minggu terakhir -->
  <div class="card">
    <h3 class="text-center">Penjualan 4 Minggu Terakhir</h3>
    <canvas id="weeklyChart"></canvas>
  </div>

  <!-- 4. User Teraktif Bulan Ini -->
  <div class="card">
    <h3 class="text-center">User Teraktif Bulan Ini</h3>
    <div id="topUser" class="text-center">Memuat data...</div>
  </div>

  <!-- 5. Ranking & Statement -->
  <div class="card ranking">
    <h3>Ranking Rokok Terjual (Bulan Ini)</h3>
    <div id="ranking"></div>
  </div>

  <div class="card statement">
    <div id="statement"></div>
  </div>

</div>

<script>
const API_KEY = "1UFX45MJDHU0E4C5";
const CHANNEL_ID = 3212911;

const rokokMap = { 1:"OFO", 2:"HD", 3:"GP", 4:"SURYA12" };
const hargaMap = { 1:12000, 2:16000, 3:22000, 4:27000 };

function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

const now = new Date();
const currentWeek = getISOWeek(now);
const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&results=8000`;

fetch(url)
.then(res => res.json())
.then(data => {

  let weeklyIncome = {};
  let monthlyQty = {};
  let monthlyIncome = 0;
  let pieQty = {};
  let weeklyTotal = 0;

  let todayQty = {};
  let todayTotal = 0;
  let userAccess = {};

  const todayStr = now.toISOString().split("T")[0];
  const startWeek = Math.max(1, currentWeek - 3);

  data.feeds.forEach(feed => {
    if (!feed.field1) return;

    const jenis = Number(feed.field1);
    const qty = feed.field2 && !isNaN(feed.field2) ? Number(feed.field2) : 1;
    const user = feed.field3;
    const date = new Date(feed.created_at);
    const week = getISOWeek(date);
    const dateStr = date.toISOString().split("T")[0];

    const nama = rokokMap[jenis];
    const harga = hargaMap[jenis];
    if (!nama) return;

    // 1. Penjualan Hari Ini
    if (dateStr === todayStr) {
      todayQty[nama] = (todayQty[nama] || 0) + qty;
      todayTotal += qty * harga;
    }

    // 2. Pie chart minggu ini
    if (week === currentWeek) {
      pieQty[nama] = (pieQty[nama] || 0) + qty;
      weeklyTotal += qty * harga;
    }

    // 3. Penjualan 4 minggu terakhir
    if (week >= startWeek && week <= currentWeek) {
      weeklyIncome[week] = (weeklyIncome[week] || 0) + qty * harga;
      monthlyQty[nama] = (monthlyQty[nama] || 0) + qty;
      monthlyIncome += qty * harga;
    }

    // 4. User paling aktif (abaikan 1111)
    if (user && user !== "1111") {
      userAccess[user] = (userAccess[user] || 0) + 1;
    }
  });

  // =========================
  // Update total penghasilan minggu ini
  // =========================
  document.getElementById("weeklyIncome").innerHTML =
    `Total Penghasilan Minggu Ini: <b>Rp ${weeklyTotal.toLocaleString("id-ID")}</b>`;

  // =========================
  // 1. Ringkasan Penjualan Hari Ini
  // =========================
  if (Object.keys(todayQty).length > 0) {
    const detail = Object.entries(todayQty)
      .map(d => `${d[0]} = ${d[1]} pcs`).join(" | ");
    document.getElementById("todaySummary").innerHTML =
      `Penjualan hari ini: Rp ${todayTotal.toLocaleString("id-ID")}<br>${detail}`;
  } else {
    document.getElementById("todaySummary").innerHTML = "Belum ada penjualan hari ini";
  }

  // =========================
  // 2. Pie Chart Minggu Ini
  // =========================
  if (Object.keys(pieQty).length > 0) {
    new Chart(document.getElementById("pieChart"), {
      type: "pie",
      data: {
        labels: Object.keys(pieQty),
        datasets: [{
          data: Object.values(pieQty),
          backgroundColor: ["#4CAF50","#2196F3","#FFC107","#E91E63"]
        }]
      }
    });
    document.getElementById("pieDetail").innerHTML =
      Object.entries(pieQty).map(d => `${d[0]}: ${d[1]} pcs`).join(" | ");
  } else {
    document.getElementById("pieDetail").innerHTML = "<i>Belum ada data minggu ini</i>";
  }

  // =========================
  // 3. Penjualan 4 Minggu Terakhir
  // =========================
  const weeks = Object.keys(weeklyIncome).map(Number).sort((a,b)=>a-b);
  const labels = weeks.map(w => w === currentWeek ? "Minggu ini" : `Minggu ${currentWeek-w}`);
  new Chart(document.getElementById("weeklyChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Penjualan (Rp)",
        data: weeks.map(w => weeklyIncome[w]),
        backgroundColor: "#673AB7"
      }]
    }
  });

  // =========================
  // 4. User Teraktif Bulan Ini (Teks saja)
  // =========================
  const sortedUsers = Object.entries(userAccess).sort((a,b)=>b[1]-a[1]);
  if (sortedUsers.length > 0) {
    document.getElementById("topUser").innerHTML =
      `${sortedUsers[0][0]} - ${sortedUsers[0][1]} kali`;
  } else {
    document.getElementById("topUser").innerHTML = "Belum ada user aktif";
  }

  // =========================
  // 5. Ranking Rokok & Statement
  // =========================
  const sortedMonthly = Object.entries(monthlyQty).sort((a,b)=>b[1]-a[1]);
  let rankingHtml = "";
  sortedMonthly.forEach((d,i) => {
    const kode = Object.keys(rokokMap).find(k => rokokMap[k] === d[0]);
    if (i < 2) {
      rankingHtml += `<p><b>${d[1]} pcs - ${d[0]} : Rp ${hargaMap[kode].toLocaleString("id-ID")}</b></p>`;
    } else {
      rankingHtml += `<p>${d[1]} pcs - ${d[0]}</p>`;
    }
  });
  document.getElementById("ranking").innerHTML = rankingHtml;

  document.getElementById("statement").innerHTML =
    monthlyIncome > 0 ?
    `Penjualan bulan ini Rp ${monthlyIncome.toLocaleString("id-ID")}. Prioritaskan stok ${sortedMonthly[0][0]} dan ${sortedMonthly[1][0]}.` :
    "Belum ada data analisa.";

})
.catch(err => {
  console.error(err);
  document.getElementById("weeklyIncome").innerHTML = "Gagal mengambil data.";
  document.getElementById("todaySummary").innerHTML = "<i>Gagal fetch data</i>";
  document.getElementById("pieDetail").innerHTML = "<i>Gagal fetch data</i>";
  document.getElementById("topUser").innerHTML = "<i>Gagal fetch data</i>";
  document.getElementById("ranking").innerHTML = "<i>Gagal fetch data</i>";
  document.getElementById("statement").innerHTML = "<i>Gagal fetch data</i>";
});
</script>

</body>
</html>
