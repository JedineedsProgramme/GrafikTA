<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Penjualan Rokok</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 30px; }
    canvas { max-width: 600px; margin-bottom: 40px; }
    h1, h2 { text-align: center; }
  </style>
</head>

<body>

<h1>Dashboard Penjualan Rokok (Tahun Berjalan)</h1>
<h2 id="totalIncome"></h2>

<canvas id="qtyChart"></canvas>
<canvas id="incomeChart"></canvas>

<script>
const rokokMap = {
  1: "OFO",
  2: "HD",
  3: "GP",
  4: "SURYA12"
};

const hargaMap = {
  1: 12000,
  2: 16000,
  3: 22000,
  4: 27000
};

function getISOWeek(date) {
  const d = new Date(Date.UTC(
    date.getFullYear(),
    date.getMonth(),
    date.getDate()
  ));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

const currentYear = new Date().getFullYear();

  fetch("https://api.thingspeak.com/channels/3212911/feeds.json?api_key=1UFX45MJDHU0E4C5&results=8000")
  .then(res => res.json())
  .then(data => {

    let qtyPerRokok = {};
    let incomePerRokok = {};
    let totalIncome = 0;

    data.feeds.forEach(feed => {

      const date = new Date(feed.created_at);
      const year = date.getFullYear();

      // ‚ùå BUANG DATA TAHUN LAIN (MINGGU 53 HILANG)
      if (year !== currentYear) return;

      const jenis = parseInt(feed.field1);
      const qty = parseInt(feed.field2) || 1;

      const nama = rokokMap[jenis];
      const harga = hargaMap[jenis];

      if (!nama || !harga) return;

      qtyPerRokok[nama] = (qtyPerRokok[nama] || 0) + qty;
      incomePerRokok[nama] = (incomePerRokok[nama] || 0) + qty * harga;
      totalIncome += qty * harga;
    });

    renderQtyChart(qtyPerRokok);
    renderIncomeChart(incomePerRokok);
    document.getElementById("totalIncome").innerHTML =
      "Total Penghasilan Tahun Ini: <b>Rp " +
      totalIncome.toLocaleString("id-ID") + "</b>";
  });

function renderQtyChart(data) {
  new Chart(document.getElementById("qtyChart"), {
    type: "pie",
    data: {
      labels: Object.keys(data),
      datasets: [{
        data: Object.values(data),
        backgroundColor: ["#4CAF50","#2196F3","#FFC107","#E91E63"]
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: "Perbandingan Rokok Terjual"
        }
      }
    }
  });
}

function renderIncomeChart(data) {
  new Chart(document.getElementById("incomeChart"), {
    type: "bar",
    data: {
      labels: Object.keys(data),
      datasets: [{
        label: "Penghasilan (Rp)",
        data: Object.values(data),
        backgroundColor: "#673AB7"
      }]
    },
    options: {
      scales: {
        y: {
          ticks: {
            callback: v => "Rp " + v.toLocaleString("id-ID")
          }
        }
      }
    }
  });
}
</script>
</body>
</html>
