<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Penjualan Rokok</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
  h1 { text-align: center; margin-bottom: 5px; }
  h2 { text-align: center; margin-top: 0; color: #2e7d32; }
  .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .card { background: #ffffff; padding: 15px; border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  canvas { max-height: 300px; }
  .text-center { text-align: center; }
  .ranking p { margin: 5px 0; }
  .statement { font-weight: bold; background: #e8f5e9;
               padding: 10px; border-radius: 8px; }
</style>
</head>

<body>

<h1>Dashboard Penjualan Rokok (Minggu Ini)</h1>
<h2 id="weeklyIncome">Total Penghasilan Minggu Ini: Rp 0</h2>

<div class="dashboard">

  <div class="card">
    <h3 class="text-center">Perbandingan Jenis Rokok Terjual</h3>
    <canvas id="pieChart"></canvas>
    <div id="pieDetail" class="text-center"></div>
  </div>

  <div class="card">
    <h3 class="text-center">Penjualan 4 Minggu Terakhir</h3>
    <canvas id="weeklyChart"></canvas>
  </div>

  <div class="card ranking">
    <h3>Ranking Rokok Terjual (Bulan Ini)</h3>
    <div id="ranking"></div>
  </div>

  <div class="card statement">
    <div id="statement"></div>
  </div>

</div>

<script>
const API_KEY = "1UFX45MJDHU0E4C5";
const CHANNEL_ID = 3212911;

const rokokMap = { 1:"OFO", 2:"HD", 3:"GP", 4:"SURYA12" };
const hargaMap = { 1:12000, 2:16000, 3:22000, 4:27000 };

function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

const now = new Date();
const currentWeek = getISOWeek(now);

fetch(`https://api.thingspeak.com/channels/3212911/feeds.json?api_key=1UFX45MJDHU0E4C5&results=8000`)
.then(res => res.json())
.then(data => {

  let weeklyIncome = {};
  let pieQty = {};
  let monthlyQty = {};
  let weeklyTotal = 0;
  let monthlyIncome = 0;

  data.feeds.forEach(feed => {
    if (!feed.field1) return;

    const date = new Date(feed.created_at);
    const week = getISOWeek(date);

    const jenis = Number(feed.field1);
    const qty = feed.field2 ? Number(feed.field2) : 1;

    const nama = rokokMap[jenis];
    const harga = hargaMap[jenis];
    if (!nama) return;

    if (week === currentWeek) {
      pieQty[nama] = (pieQty[nama] || 0) + qty;
      weeklyTotal += qty * harga;
    }

    if (week >= currentWeek - 3 && week <= currentWeek) {
      weeklyIncome[week] = (weeklyIncome[week] || 0) + qty * harga;
      monthlyQty[nama] = (monthlyQty[nama] || 0) + qty;
      monthlyIncome += qty * harga;
    }
  });

  document.getElementById("weeklyIncome").innerHTML =
    `Total Penghasilan Minggu Ini: <b>Rp ${weeklyTotal.toLocaleString("id-ID")}</b>`;

  if (Object.keys(monthlyQty).length === 0) {
    document.getElementById("ranking").innerHTML = "<i>Belum ada data</i>";
    document.getElementById("statement").innerHTML = "Belum ada data analisa.";
    return;
  }

  renderPieChart(pieQty);
  renderWeeklyChart(weeklyIncome);
  renderRanking(monthlyQty);
  renderStatement(monthlyIncome, monthlyQty);
});

function renderPieChart(data) {
  if (Object.keys(data).length === 0) {
    document.getElementById("pieDetail").innerHTML = "<i>Belum ada data minggu ini</i>";
    return;
  }

  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: Object.keys(data),
      datasets: [{
        data: Object.values(data),
        backgroundColor: ["#4CAF50","#2196F3","#FFC107","#E91E63"]
      }]
    }
  });

  document.getElementById("pieDetail").innerHTML =
    Object.entries(data).map(d => `${d[0]}: ${d[1]} pcs`).join(" | ");
}

function renderWeeklyChart(data) {
  const weeks = Object.keys(data).map(Number).sort((a,b)=>a-b);
  const labels = weeks.map(w => w === currentWeek ? "Minggu ini" : `Minggu ${currentWeek-w}`);

  new Chart(document.getElementById("weeklyChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Penjualan (Rp)",
        data: weeks.map(w => data[w]),
        backgroundColor: "#673AB7"
      }]
    }
  });
}

function renderRanking(data) {
  const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
  let html = "";

  sorted.forEach((d,i) => {
    const kode = Object.keys(rokokMap).find(k => rokokMap[k] === d[0]);

    if (i < 2) {
      html += `<p><b>${d[1]} pcs - ${d[0]} : Rp ${hargaMap[kode].toLocaleString("id-ID")}</b></p>`;
    } else {
      html += `<p>${d[1]} pcs - ${d[0]}</p>`;
    }
  });

  document.getElementById("ranking").innerHTML = html;
}

function renderStatement(total, data) {
  const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
  document.getElementById("statement").innerHTML =
    `Penjualan bulan ini Rp ${total.toLocaleString("id-ID")}. 
     Prioritaskan stok ${sorted[0][0]} dan ${sorted[1][0]}.`;
}
</script>

</body>
</html>

